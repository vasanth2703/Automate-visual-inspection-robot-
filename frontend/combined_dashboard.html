<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AMR Complete Dashboard - 3D + Data</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #1a202c;
            color: white;
            overflow: hidden;
        }
        .container {
            display: grid;
            grid-template-columns: 1fr 400px;
            grid-template-rows: 60px 1fr;
            height: 100vh;
            gap: 0;
        }
        .header {
            grid-column: 1 / -1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .header h1 {
            font-size: 24px;
            font-weight: 600;
        }
        .header-controls {
            display: flex;
            gap: 10px;
        }
        .btn {
            padding: 8px 20px;
            border: none;
            border-radius: 5px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary { background: white; color: #667eea; }
        .btn-primary:hover { background: #f0f0f0; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }
        .btn-secondary:hover { background: rgba(255,255,255,0.3); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        #canvas3d {
            width: 100%;
            height: 100%;
            display: block;
        }
        .sidebar {
            background: #2d3748;
            overflow-y: auto;
            padding: 20px;
        }
        .panel {
            background: #1a202c;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }
        .panel h3 {
            font-size: 14px;
            margin-bottom: 12px;
            color: #a0aec0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .control-item {
            margin-bottom: 12px;
        }
        .control-item label {
            display: block;
            font-size: 11px;
            color: #a0aec0;
            margin-bottom: 5px;
            font-weight: 600;
        }
        input[type="range"] {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #4a5568;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: #667eea;
            cursor: pointer;
        }
        select {
            width: 100%;
            padding: 8px;
            background: #4a5568;
            border: none;
            border-radius: 5px;
            color: white;
            font-size: 13px;
        }
        .value-display {
            color: #667eea;
            font-weight: 600;
            font-size: 14px;
        }
        .status-box {
            background: #4a5568;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            margin-top: 8px;
        }
        .status-box .label {
            color: #a0aec0;
            font-size: 10px;
            text-transform: uppercase;
        }
        .status-box .value {
            color: white;
            font-weight: 600;
            margin-top: 3px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background: #4a5568;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 8px;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
        }
        .results-list {
            max-height: 300px;
            overflow-y: auto;
        }
        .result-item {
            background: #4a5568;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 8px;
            font-size: 12px;
        }
        .result-item .height {
            color: #667eea;
            font-weight: 600;
            margin-bottom: 5px;
        }
        .result-item .detections {
            color: #a0aec0;
        }
        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            margin: 2px;
        }
        .badge-success { background: #48bb78; color: white; }
        .badge-warning { background: #ed8936; color: white; }
        .badge-danger { background: #f56565; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ðŸ¤– AMR Scanning System - Complete Dashboard</h1>
            <div class="header-controls">
                <button class="btn btn-primary" id="startScanBtn">Start Scan</button>
                <button class="btn btn-secondary" id="resetBtn">Reset</button>
            </div>
        </div>
        
        <div>
            <canvas id="canvas3d"></canvas>
        </div>
        
        <div class="sidebar">
            <div class="panel">
                <h3>Position Control</h3>
                <div class="control-item">
                    <label>AMR Position (X-Axis)</label>
                    <input type="range" id="amrXSlider" min="0" max="2" step="0.1" value="0">
                    <span class="value-display" id="amrXValue">0.0 m</span>
                </div>
                <div class="control-item">
                    <label>Lift Height (Y-Axis)</label>
                    <input type="range" id="heightSlider" min="0.3" max="2.3" step="0.1" value="0.3">
                    <span class="value-display" id="heightValue">0.3 m</span>
                </div>
                <div class="control-item">
                    <label>Camera Mode</label>
                    <select id="cameraMode">
                        <option value="crop">Crop Mode</option>
                        <option value="random">Random Mode</option>
                    </select>
                </div>
            </div>
            
            <div class="panel">
                <h3>Scan Status</h3>
                <div class="status-box">
                    <div class="label">Current State</div>
                    <div class="value" id="statusText">Ready</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%">0%</div>
                </div>
                <div class="status-box">
                    <div class="label">Current Height</div>
                    <div class="value" id="currentHeight">0.3 m</div>
                </div>
                <div class="status-box">
                    <div class="label">Scan Progress</div>
                    <div class="value" id="scanProgress">0 / 8 heights</div>
                </div>
            </div>
            
            <div class="panel">
                <h3>Scan Results</h3>
                <div class="results-list" id="resultsList">
                    <p style="color: #a0aec0; text-align: center; font-size: 12px;">No results yet</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, amrGroup, liftGroup, bracketGroup, cameras3D = [];
        let isScanning = false;
        let scanHeights = [0.3, 0.6, 0.9, 1.2, 1.5, 1.8, 2.1, 2.3];
        let currentScanIndex = 0;
        let scanResults = [];
        const API_BASE = 'http://localhost:8000';
        
        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x1a202c);
            
            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.set(6, 3, 6);
            camera.lookAt(0, 1, 0);
            
            const canvas = document.getElementById('canvas3d');
            renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
            renderer.shadowMap.enabled = true;
            
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(5, 10, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            const pointLight1 = new THREE.PointLight(0x667eea, 0.6);
            pointLight1.position.set(-4, 2, -4);
            scene.add(pointLight1);
            
            const pointLight2 = new THREE.PointLight(0x764ba2, 0.6);
            pointLight2.position.set(4, 2, 4);
            scene.add(pointLight2);
            
            const groundGeometry = new THREE.PlaneGeometry(15, 15);
            const groundMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d3748,
                roughness: 0.9
            });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            scene.add(ground);
            
            const gridHelper = new THREE.GridHelper(15, 15, 0x4a5568, 0x2d3748);
            scene.add(gridHelper);
            
            const wallGeometry = new THREE.BoxGeometry(4, 3, 0.2);
            const wallMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x718096,
                roughness: 0.6
            });
            const wall = new THREE.Mesh(wallGeometry, wallMaterial);
            wall.position.set(0, 1.5, -2.5);
            wall.receiveShadow = true;
            wall.castShadow = true;
            scene.add(wall);
            
            createAMR();
            
            window.addEventListener('resize', onWindowResize);
            document.getElementById('amrXSlider').addEventListener('input', updateAMRPosition);
            document.getElementById('heightSlider').addEventListener('input', updateLiftHeight);
            document.getElementById('startScanBtn').addEventListener('click', startScan);
            document.getElementById('resetBtn').addEventListener('click', resetPosition);
            
            animate();
        }
        
        function createAMR() {
            amrGroup = new THREE.Group();
            
            const baseGeometry = new THREE.BoxGeometry(1, 0.2, 0.8);
            const baseMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x4299e1,
                metalness: 0.6,
                roughness: 0.3
            });
            const base = new THREE.Mesh(baseGeometry, baseMaterial);
            base.castShadow = true;
            amrGroup.add(base);
            
            const wheelGeometry = new THREE.CylinderGeometry(0.1, 0.1, 0.05, 16);
            const wheelMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x2d3748,
                metalness: 0.8
            });
            
            [[-0.4, -0.1, 0.3], [0.4, -0.1, 0.3], [-0.4, -0.1, -0.3], [0.4, -0.1, -0.3]].forEach(pos => {
                const wheel = new THREE.Mesh(wheelGeometry, wheelMaterial);
                wheel.rotation.z = Math.PI / 2;
                wheel.position.set(...pos);
                wheel.castShadow = true;
                amrGroup.add(wheel);
            });
            
            liftGroup = new THREE.Group();
            liftGroup.position.y = 0.1;
            
            const columnGeometry = new THREE.BoxGeometry(0.15, 2.5, 0.15);
            const columnMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x48bb78,
                metalness: 0.7,
                roughness: 0.2
            });
            const column = new THREE.Mesh(columnGeometry, columnMaterial);
            column.position.y = 1.25;
            column.castShadow = true;
            liftGroup.add(column);
            
            bracketGroup = new THREE.Group();
            bracketGroup.position.y = 0.3;
            
            const armGeometry = new THREE.BoxGeometry(1.2, 0.1, 0.3);
            const armMaterial = new THREE.MeshStandardMaterial({ 
                color: 0xed8936,
                metalness: 0.5,
                roughness: 0.4
            });
            const arm = new THREE.Mesh(armGeometry, armMaterial);
            arm.castShadow = true;
            bracketGroup.add(arm);
            
            const cameraGeometry = new THREE.BoxGeometry(0.15, 0.15, 0.2);
            const cameraMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x9f7aea,
                metalness: 0.8,
                roughness: 0.2
            });
            
            [-0.4, 0, 0.4].forEach(xPos => {
                const cam = new THREE.Mesh(cameraGeometry, cameraMaterial);
                cam.position.set(xPos, -0.15, 0.2);
                cam.castShadow = true;
                
                const lensGeometry = new THREE.CircleGeometry(0.05, 16);
                const lensMaterial = new THREE.MeshBasicMaterial({ 
                    color: 0x00ffff,
                    transparent: true,
                    opacity: 0.7
                });
                const lens = new THREE.Mesh(lensGeometry, lensMaterial);
                lens.position.z = 0.11;
                cam.add(lens);
                
                const light = new THREE.PointLight(0x00ffff, 0, 2);
                light.position.z = 0.3;
                cam.add(light);
                cam.userData.light = light;
                
                bracketGroup.add(cam);
                cameras3D.push(cam);
            });
            
            liftGroup.add(bracketGroup);
            amrGroup.add(liftGroup);
            amrGroup.position.set(0, 0.1, 0);
            scene.add(amrGroup);
        }
        
        function updateAMRPosition(e) {
            const x = parseFloat(e.target.value);
            amrGroup.position.x = x;
            document.getElementById('amrXValue').textContent = x.toFixed(1) + ' m';
        }
        
        function updateLiftHeight(e) {
            const height = parseFloat(e.target.value);
            bracketGroup.position.y = height;
            document.getElementById('heightValue').textContent = height.toFixed(1) + ' m';
            document.getElementById('currentHeight').textContent = height.toFixed(1) + ' m';
        }
        
        function resetPosition() {
            amrGroup.position.x = 0;
            bracketGroup.position.y = 0.3;
            document.getElementById('amrXSlider').value = 0;
            document.getElementById('heightSlider').value = 0.3;
            updateSliderDisplays();
            scanResults = [];
            updateResultsList();
            updateStatus('Reset to initial position');
        }
        
        function updateSliderDisplays() {
            const x = parseFloat(document.getElementById('amrXSlider').value);
            const h = parseFloat(document.getElementById('heightSlider').value);
            document.getElementById('amrXValue').textContent = x.toFixed(1) + ' m';
            document.getElementById('heightValue').textContent = h.toFixed(1) + ' m';
            document.getElementById('currentHeight').textContent = h.toFixed(1) + ' m';
        }
        
        async function startScan() {
            if (isScanning) return;
            isScanning = true;
            currentScanIndex = 0;
            scanResults = [];
            document.getElementById('startScanBtn').disabled = true;
            updateStatus('Initializing scan...');
            
            const amrX = parseFloat(document.getElementById('amrXSlider').value);
            const cameraMode = document.getElementById('cameraMode').value;
            
            try {
                await fetch(`${API_BASE}/scan/start`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amr_x: amrX, camera_mode: cameraMode })
                });
            } catch (error) {
                console.log('Backend offline - visual simulation only');
            }
            
            animateScan();
        }
        
        function animateScan() {
            if (currentScanIndex >= scanHeights.length) {
                isScanning = false;
                document.getElementById('startScanBtn').disabled = false;
                updateStatus('âœ“ Scan complete!');
                updateProgress(100);
                return;
            }
            
            const targetHeight = scanHeights[currentScanIndex];
            updateStatus(`Moving to ${targetHeight.toFixed(1)}m...`);
            
            animateLiftTo(targetHeight, () => {
                updateStatus('Stabilizing...');
                setTimeout(() => {
                    updateStatus('Capturing images...');
                    flashCameras();
                    setTimeout(() => {
                        updateStatus('AI detection running...');
                        const detections = Math.floor(Math.random() * 12);
                        scanResults.push({ height: targetHeight, detections });
                        updateResultsList();
                        
                        const progress = ((currentScanIndex + 1) / scanHeights.length * 100);
                        updateProgress(progress);
                        document.getElementById('scanProgress').textContent = 
                            `${currentScanIndex + 1} / ${scanHeights.length} heights`;
                        
                        currentScanIndex++;
                        setTimeout(animateScan, 400);
                    }, 400);
                }, 300);
            });
        }
        
        function animateLiftTo(targetHeight, callback) {
            const startHeight = bracketGroup.position.y;
            const duration = 600;
            const startTime = Date.now();
            
            function animate() {
                const elapsed = Date.now() - startTime;
                const progress = Math.min(elapsed / duration, 1);
                const eased = progress < 0.5 ? 2 * progress * progress : 1 - Math.pow(-2 * progress + 2, 2) / 2;
                
                bracketGroup.position.y = startHeight + (targetHeight - startHeight) * eased;
                document.getElementById('heightSlider').value = bracketGroup.position.y;
                updateSliderDisplays();
                
                if (progress < 1) {
                    requestAnimationFrame(animate);
                } else {
                    callback();
                }
            }
            animate();
        }
        
        function flashCameras() {
            cameras3D.forEach((cam, idx) => {
                setTimeout(() => {
                    const lens = cam.children[0];
                    const light = cam.userData.light;
                    
                    lens.material.opacity = 1;
                    lens.material.emissive = new THREE.Color(0x00ffff);
                    lens.material.emissiveIntensity = 2;
                    light.intensity = 3;
                    
                    setTimeout(() => {
                        lens.material.opacity = 0.7;
                        lens.material.emissiveIntensity = 0;
                        light.intensity = 0;
                    }, 150);
                }, idx * 120);
            });
        }
        
        function updateStatus(message) {
            document.getElementById('statusText').textContent = message;
        }
        
        function updateProgress(percent) {
            const fill = document.getElementById('progressFill');
            fill.style.width = percent + '%';
            fill.textContent = Math.round(percent) + '%';
        }
        
        function updateResultsList() {
            const list = document.getElementById('resultsList');
            if (scanResults.length === 0) {
                list.innerHTML = '<p style="color: #a0aec0; text-align: center; font-size: 12px;">No results yet</p>';
                return;
            }
            
            list.innerHTML = scanResults.map(r => {
                const badge = r.detections === 0 ? 'badge-success' : 
                             r.detections < 5 ? 'badge-warning' : 'badge-danger';
                return `
                    <div class="result-item">
                        <div class="height">Height: ${r.height.toFixed(1)}m</div>
                        <div class="detections">
                            <span class="badge ${badge}">${r.detections} detections</span>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function animate() {
            requestAnimationFrame(animate);
            
            const time = Date.now() * 0.0002;
            camera.position.x = Math.cos(time) * 6;
            camera.position.z = Math.sin(time) * 6;
            camera.lookAt(0, 1.2, 0);
            
            renderer.render(scene, camera);
        }
        
        function onWindowResize() {
            const canvas = document.getElementById('canvas3d');
            camera.aspect = canvas.clientWidth / canvas.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(canvas.clientWidth, canvas.clientHeight);
        }
        
        init();
    </script>
</body>
</html>
