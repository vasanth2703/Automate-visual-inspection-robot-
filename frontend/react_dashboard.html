<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Industrial Inspection Dashboard - YOLO + PatchCore</title>
    
    <!-- React & Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .status-normal { background: #10b981; }
        .status-defective { background: #ef4444; }
        .status-unknown { background: #6b7280; }
        .pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // Supabase Configuration
        const SUPABASE_URL = 'https://hkvxcupixalyamfyevgv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImhrdnhjdXBpeGFseWFtZnlldmd2Iiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc1NjYyMTI0OSwiZXhwIjoyMDcyMTk3MjQ5fQ.pwd1wh8cSEXL3omv3AHbAXKT8t1LCMpAShLbAuEiHr0';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        const API_BASE = 'http://localhost:8000';
    </script>
</body>
</html>

    <script type="text/babel">
        // ============================================================================
        // COMPONENTS
        // ============================================================================
        
        // Header Component
        const Header = ({ connected }) => (
            <div className="gradient-bg text-white p-6 shadow-lg">
                <div className="max-w-7xl mx-auto flex justify-between items-center">
                    <div>
                        <h1 className="text-3xl font-bold">Industrial Inspection System</h1>
                        <p className="text-blue-100 mt-1">YOLO + PatchCore AI-Powered Quality Control</p>
                    </div>
                    <div className="flex items-center gap-2">
                        <span className={`inline-block w-3 h-3 rounded-full ${connected ? 'bg-green-400' : 'bg-red-400'}`}></span>
                        <span className="text-sm">{connected ? 'Connected' : 'Disconnected'}</span>
                    </div>
                </div>
            </div>
        );
        
        // Stats Card Component
        const StatsCard = ({ title, value, icon, color, trend }) => (
            <div className="card p-6">
                <div className="flex items-center justify-between">
                    <div>
                        <p className="text-gray-500 text-sm font-medium">{title}</p>
                        <p className={`text-3xl font-bold mt-2 ${color}`}>{value}</p>
                        {trend && <p className="text-sm text-gray-600 mt-1">{trend}</p>}
                    </div>
                    <div className={`text-4xl ${color}`}>{icon}</div>
                </div>
            </div>
        );
        
        // Scan List Component
        const ScanList = ({ scans, onSelectScan, selectedScanId }) => (
            <div className="card p-6">
                <h2 className="text-xl font-bold mb-4">Recent Scans</h2>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                    {scans.map(scan => (
                        <div
                            key={scan.scan_id}
                            onClick={() => onSelectScan(scan.scan_id)}
                            className={`p-4 rounded-lg cursor-pointer transition ${
                                selectedScanId === scan.scan_id 
                                    ? 'bg-blue-50 border-2 border-blue-500' 
                                    : 'bg-gray-50 hover:bg-gray-100'
                            }`}
                        >
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-semibold text-sm">
                                        {new Date(scan.start_time).toLocaleString()}
                                    </p>
                                    <p className="text-xs text-gray-600 mt-1">
                                        Side: {scan.side} | Status: {scan.status}
                                    </p>
                                </div>
                                <div className="text-right">
                                    <p className="text-sm font-bold">{scan.total_components}</p>
                                    <p className="text-xs text-gray-500">components</p>
                                </div>
                            </div>
                            <div className="mt-2 flex gap-2">
                                <span className="px-2 py-1 bg-green-100 text-green-800 text-xs rounded">
                                    {scan.normal_count || 0} Normal
                                </span>
                                <span className="px-2 py-1 bg-red-100 text-red-800 text-xs rounded">
                                    {scan.defective_count || 0} Defective
                                </span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // Detection Details Component
        const DetectionDetails = ({ detections }) => (
            <div className="card p-6">
                <h2 className="text-xl font-bold mb-4">Detection Details</h2>
                <div className="space-y-3 max-h-96 overflow-y-auto">
                    {detections.map((det, idx) => (
                        <div key={idx} className="p-4 bg-gray-50 rounded-lg">
                            <div className="flex justify-between items-start">
                                <div className="flex-1">
                                    <p className="font-semibold">{det.component_name}</p>
                                    <div className="mt-2 space-y-1 text-sm">
                                        <p className="text-gray-600">
                                            YOLO Confidence: <span className="font-medium">{(det.yolo_conf * 100).toFixed(1)}%</span>
                                        </p>
                                        <p className="text-gray-600">
                                            Anomaly Score: <span className="font-medium">{(det.patchcore_score * 100).toFixed(1)}%</span>
                                        </p>
                                    </div>
                                </div>
                                <span className={`px-3 py-1 rounded-full text-xs font-semibold text-white ${
                                    det.patchcore_status === 'NORMAL' ? 'status-normal' :
                                    det.patchcore_status === 'DEFECTIVE' ? 'status-defective' :
                                    'status-unknown'
                                }`}>
                                    {det.patchcore_status}
                                </span>
                            </div>
                            {det.heatmap_url && (
                                <button className="mt-2 text-blue-600 text-sm hover:underline">
                                    View Heatmap
                                </button>
                            )}
                        </div>
                    ))}
                </div>
            </div>
        );
        
        // Component Statistics Component
        const ComponentStats = ({ stats }) => (
            <div className="card p-6">
                <h2 className="text-xl font-bold mb-4">Component Statistics</h2>
                <div className="space-y-2 max-h-96 overflow-y-auto">
                    {stats.map((stat, idx) => (
                        <div key={idx} className="p-3 bg-gray-50 rounded-lg">
                            <div className="flex justify-between items-center">
                                <span className="font-medium text-sm">{stat.component_name}</span>
                                <span className="text-xs text-gray-600">{stat.total_detected} detected</span>
                            </div>
                            <div className="mt-2 w-full bg-gray-200 rounded-full h-2">
                                <div 
                                    className="bg-red-500 h-2 rounded-full"
                                    style={{ width: `${(stat.total_defective / stat.total_detected * 100)}%` }}
                                ></div>
                            </div>
                            <div className="mt-1 flex justify-between text-xs text-gray-600">
                                <span>{stat.total_normal} normal</span>
                                <span>{stat.total_defective} defective</span>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );

        // Real-time Chart Component
        const DefectChart = ({ data }) => {
            const chartRef = useRef(null);
            const chartInstance = useRef(null);
            
            useEffect(() => {
                if (chartRef.current && data.length > 0) {
                    const ctx = chartRef.current.getContext('2d');
                    
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                    
                    chartInstance.current = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Normal', 'Defective', 'Unknown'],
                            datasets: [{
                                data: [
                                    data.filter(d => d.patchcore_status === 'NORMAL').length,
                                    data.filter(d => d.patchcore_status === 'DEFECTIVE').length,
                                    data.filter(d => d.patchcore_status === 'UNKNOWN').length
                                ],
                                backgroundColor: ['#10b981', '#ef4444', '#6b7280']
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom' }
                            }
                        }
                    });
                }
                
                return () => {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }
                };
            }, [data]);
            
            return (
                <div className="card p-6">
                    <h2 className="text-xl font-bold mb-4">Detection Distribution</h2>
                    <div style={{ height: '300px' }}>
                        <canvas ref={chartRef}></canvas>
                    </div>
                </div>
            );
        };
        
        // Live Feed Component with ThreeJS Integration
        const LiveFeed = ({ isScanning, latestFrame }) => {
            const [imageLoaded, setImageLoaded] = React.useState(false);
            const [imageError, setImageError] = React.useState(false);
            const imgRef = React.useRef(null);
            
            React.useEffect(() => {
                if (latestFrame && latestFrame.image_url) {
                    setImageLoaded(false);
                    setImageError(false);
                }
            }, [latestFrame]);
            
            return (
                <div className="card p-6">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">Live Camera Feed</h2>
                        {isScanning && (
                            <span className="flex items-center text-green-600">
                                <span className="pulse inline-block w-3 h-3 bg-green-600 rounded-full mr-2"></span>
                                Scanning...
                            </span>
                        )}
                    </div>
                    <div className="bg-gray-900 rounded-lg aspect-video flex items-center justify-center overflow-hidden relative">
                        {latestFrame && latestFrame.image_url ? (
                            <>
                                <img 
                                    ref={imgRef}
                                    src={latestFrame.image_url}
                                    alt="Camera feed"
                                    className={`w-full h-full object-contain ${imageLoaded ? 'opacity-100' : 'opacity-0'}`}
                                    onLoad={() => setImageLoaded(true)}
                                    onError={() => setImageError(true)}
                                    crossOrigin="anonymous"
                                />
                                {!imageLoaded && !imageError && (
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="text-gray-400">Loading image...</div>
                                    </div>
                                )}
                                {imageError && (
                                    <div className="absolute inset-0 flex items-center justify-center">
                                        <div className="text-gray-400">Image not available</div>
                                    </div>
                                )}
                            </>
                        ) : (
                            <div className="text-center">
                                <p className="text-gray-400 mb-2">Waiting for camera feed...</p>
                                <p className="text-gray-500 text-sm">Start a scan to see live images</p>
                            </div>
                        )}
                    </div>
                    {latestFrame && (
                        <div className="mt-2 flex justify-between text-sm text-gray-600">
                            <span>Camera: {latestFrame.camera_id} | Height: {latestFrame.height_level}m</span>
                            <span className="text-xs text-gray-500">
                                {new Date(latestFrame.timestamp).toLocaleTimeString()}
                            </span>
                        </div>
                    )}
                </div>
            );
        };

        // Notification Component
        const Notification = ({ message, type = 'info' }) => {
            const colors = {
                info: 'bg-blue-500',
                success: 'bg-green-500',
                warning: 'bg-yellow-500',
                error: 'bg-red-500'
            };
            
            return (
                <div className={`fixed top-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in`}>
                    {message}
                </div>
            );
        };
        
        // Main Dashboard Component
        const Dashboard = () => {
            const [scans, setScans] = useState([]);
            const [selectedScanId, setSelectedScanId] = useState(null);
            const [detections, setDetections] = useState([]);
            const [componentStats, setComponentStats] = useState([]);
            const [isScanning, setIsScanning] = useState(false);
            const [latestFrame, setLatestFrame] = useState(null);
            const [notification, setNotification] = useState(null);
            const [connected, setConnected] = useState(false);
            const [stats, setStats] = useState({
                totalScans: 0,
                totalComponents: 0,
                defectiveCount: 0,
                normalCount: 0
            });
            
            const showNotification = (message, type = 'info') => {
                setNotification({ message, type });
                setTimeout(() => setNotification(null), 3000);
            };
            
            // Fetch recent scans
            const fetchScans = async () => {
                try {
                    const { data, error } = await supabase
                        .from('scans')
                        .select('*')
                        .order('start_time', { ascending: false })
                        .limit(20);
                    
                    if (error) throw error;
                    setScans(data || []);
                    
                    // Calculate stats
                    const totalComponents = data.reduce((sum, s) => sum + (s.total_components || 0), 0);
                    const defectiveCount = data.reduce((sum, s) => sum + (s.defective_count || 0), 0);
                    const normalCount = data.reduce((sum, s) => sum + (s.normal_count || 0), 0);
                    
                    setStats({
                        totalScans: data.length,
                        totalComponents,
                        defectiveCount,
                        normalCount
                    });
                } catch (error) {
                    console.error('Error fetching scans:', error);
                }
            };
            
            // Fetch detections for selected scan
            const fetchDetections = async (scanId) => {
                try {
                    const { data, error } = await supabase
                        .from('detections')
                        .select('*')
                        .eq('scan_id', scanId)
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    setDetections(data || []);
                } catch (error) {
                    console.error('Error fetching detections:', error);
                }
            };
            
            // Fetch latest frame for live feed
            const fetchLatestFrame = async () => {
                try {
                    const { data, error } = await supabase
                        .from('frames')
                        .select('*')
                        .order('timestamp', { ascending: false })
                        .limit(1);
                    
                    if (error) throw error;
                    if (data && data.length > 0) {
                        setLatestFrame(data[0]);
                    }
                } catch (error) {
                    console.error('Error fetching latest frame:', error);
                }
            };
            
            // Fetch component statistics
            const fetchComponentStats = async () => {
                try {
                    const { data, error } = await supabase
                        .from('component_stats')
                        .select('*')
                        .order('total_detected', { ascending: false })
                        .limit(10);
                    
                    if (error) throw error;
                    setComponentStats(data || []);
                } catch (error) {
                    console.error('Error fetching component stats:', error);
                }
            };
            
            // Start new scan
            const startScan = async () => {
                setIsScanning(true);
                try {
                    const response = await fetch(`${API_BASE}/scan/start`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            amr_x: 0,
                            camera_mode: 'crop',
                            four_side_scan: false
                        })
                    });
                    
                    const data = await response.json();
                    console.log('Scan started:', data);
                    showNotification('Scan started! Watch the live feed...', 'success');
                    
                    // Keep scanning status until we detect completion
                    // Real-time subscriptions will update the UI
                } catch (error) {
                    console.error('Error starting scan:', error);
                    showNotification('Failed to start scan', 'error');
                    setIsScanning(false);
                }
            };
            
            // Handle scan selection
            const handleSelectScan = (scanId) => {
                setSelectedScanId(scanId);
                fetchDetections(scanId);
            };
            
            // Initial load
            useEffect(() => {
                fetchScans();
                fetchComponentStats();
                fetchLatestFrame();
                
                // Auto-refresh every 5 seconds for live feed
                const interval = setInterval(() => {
                    fetchScans();
                    fetchComponentStats();
                    fetchLatestFrame();
                    if (selectedScanId) {
                        fetchDetections(selectedScanId);
                    }
                }, 5000);
                
                return () => clearInterval(interval);
            }, [selectedScanId]);
            
            // Real-time subscriptions with proper cleanup
            useEffect(() => {
                console.log('Setting up real-time subscriptions...');
                
                // Create a single channel for all subscriptions
                const channel = supabase
                    .channel('realtime-updates')
                    .on('postgres_changes', 
                        { event: '*', schema: 'public', table: 'scans' },
                        (payload) => {
                            console.log('Scan update:', payload);
                            fetchScans();
                            fetchComponentStats();
                            
                            // Check if scan completed
                            if (payload.new && payload.new.status === 'completed') {
                                setIsScanning(false);
                                showNotification('Scan completed!', 'success');
                            }
                        }
                    )
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'frames' },
                        (payload) => {
                            console.log('New frame:', payload);
                            setLatestFrame(payload.new);
                            setIsScanning(true);
                            fetchLatestFrame();
                            showNotification(`Camera ${payload.new.camera_id} captured`, 'info');
                        }
                    )
                    .on('postgres_changes',
                        { event: 'INSERT', schema: 'public', table: 'detections' },
                        (payload) => {
                            console.log('New detection:', payload);
                            if (selectedScanId === payload.new.scan_id) {
                                fetchDetections(selectedScanId);
                            }
                            fetchComponentStats();
                        }
                    )
                    .subscribe((status) => {
                        console.log('Subscription status:', status);
                        if (status === 'SUBSCRIBED') {
                            setConnected(true);
                            showNotification('Real-time updates active', 'success');
                        } else if (status === 'CLOSED') {
                            setConnected(false);
                        }
                    });
                
                return () => {
                    console.log('Cleaning up subscriptions...');
                    supabase.removeChannel(channel);
                };
            }, [selectedScanId]);

            return (
                <div className="min-h-screen bg-gray-50">
                    {notification && <Notification message={notification.message} type={notification.type} />}
                    <Header connected={connected} />
                    
                    <div className="max-w-7xl mx-auto p-6">
                        {/* Stats Overview */}
                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <StatsCard 
                                title="Total Scans" 
                                value={stats.totalScans}
                                icon="ðŸ“Š"
                                color="text-blue-600"
                            />
                            <StatsCard 
                                title="Components Inspected" 
                                value={stats.totalComponents}
                                icon="ðŸ”"
                                color="text-purple-600"
                            />
                            <StatsCard 
                                title="Normal" 
                                value={stats.normalCount}
                                icon="âœ“"
                                color="text-green-600"
                            />
                            <StatsCard 
                                title="Defective" 
                                value={stats.defectiveCount}
                                icon="âš "
                                color="text-red-600"
                                trend={`${((stats.defectiveCount / stats.totalComponents) * 100 || 0).toFixed(1)}% defect rate`}
                            />
                        </div>
                        
                        {/* Control Panel */}
                        <div className="card p-6 mb-6">
                            <div className="flex justify-between items-center">
                                <div>
                                    <h2 className="text-xl font-bold">Control Panel</h2>
                                    <p className="text-gray-600 text-sm mt-1">Start new inspection or manage system</p>
                                </div>
                                <button
                                    onClick={startScan}
                                    disabled={isScanning}
                                    className={`px-6 py-3 rounded-lg font-semibold text-white transition ${
                                        isScanning 
                                            ? 'bg-gray-400 cursor-not-allowed' 
                                            : 'bg-blue-600 hover:bg-blue-700'
                                    }`}
                                >
                                    {isScanning ? 'Scanning...' : 'Start New Scan'}
                                </button>
                            </div>
                        </div>
                        
                        {/* Main Content Grid */}
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Left Column */}
                            <div className="space-y-6">
                                <ScanList 
                                    scans={scans} 
                                    onSelectScan={handleSelectScan}
                                    selectedScanId={selectedScanId}
                                />
                                <ComponentStats stats={componentStats} />
                            </div>
                            
                            {/* Middle Column */}
                            <div className="space-y-6">
                                <LiveFeed isScanning={isScanning} latestFrame={latestFrame} />
                                <DefectChart data={detections} />
                            </div>
                            
                            {/* Right Column */}
                            <div>
                                <DetectionDetails detections={detections} />
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // Render App
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Dashboard />);
    </script>
</body>
</html>
